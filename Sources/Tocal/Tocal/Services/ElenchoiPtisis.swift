//
//  PreFlightChecks.swift
//  TikTokTips
//
//  Created by Eric Cartmenez on 05/07/2020.
//  Copyright Â© 2020 Eric Cartmenez All rights reserved.
//

import UIKit
import WebKit
//import CryptoSwift
//import DeviceTools
//import Networking

public enum zF7OGwLJ3Y5uyoB6yMcn4ImQwHhCHltN: Equatable {
    case BOaLQPyvnMF0uKAl8WDYb6hg5SBGh0pu
    case FcZQGrfLSfR3kkjjJgexzvQ7pPfKmuLL(connectionError: Bool)
    case pQlnAZPLZYjey5rhztFBGqI8andRYmLr
    case jJ9Z9tcqnHSMdWKEDvOgiYFZHZCD3WnG
    case b9paGZcu09JfPbNVp7r4bFQoAQj9F8q2(title: String, body: String, url: URL)
}

// MARK: - Encryption stuff

extension IwV1W2ExckCMSUL4tw6yjGX7wf8Xj58s {

    private static func Kth38f4vasAIEwn9ujOjSPTp2VXtfBBa(cryptedMessage: String) -> zHOQQcOAadeuiYD6RtfJHyRDssayC3ZL? {
        guard let cipher = GcPhhrgRSEIKeLN7jIrbXmhPmQNsGnoa.LBln5XgLmIO6j0ei6x7iqe0ROAGm46GP(cryptedMessage: cryptedMessage) else { return nil }
        do {
            return try JSONDecoder().decode(zHOQQcOAadeuiYD6RtfJHyRDssayC3ZL.self, from: Data(bytes: cipher, count: cipher.count))
        } catch {
            print(error)
            return nil
        }
    }

}

public struct IwV1W2ExckCMSUL4tw6yjGX7wf8Xj58s {

    // MARK: - Private properties

    private static let sY5md4yqp1kulKje1Vv9Rg3l9LNVS1yS = GyVdk6JyHecjDyYHKgALpPUXqaaPn0Da<RBiSyKE4En773hSSDHFoN2lHb37cDW0Z>(engine: .customSession)

    @discardableResult static func HnZX85EtEx5reK7n2Flefohp7ge4f8lN() -> String {
        guard let userID: String = p38tislEkDmfaM5Trf2CDA3uaTpqRNLe.GbR8SmF1xXRisrMmXjUPXkrOdQLpVxTp(for: .J1gO5CBFmNltV9t8lQxYJbThQAoHhHGD) else {
            let uuidString = UUID().uuidString
            p38tislEkDmfaM5Trf2CDA3uaTpqRNLe.XEaHoJcMOewthI8CUuDkUl3FbYB7jIna(value: uuidString, for: .J1gO5CBFmNltV9t8lQxYJbThQAoHhHGD)
            return uuidString
        }
        return userID
    }

    // MARK: - Interface

    public static var mhEVo2Eta1LX3khvNjmP0QxQ71tngX0r: Bool {
        OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.RilphweD7muYuJGQ7hAbYKdazAY1lUGk == false && OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.adv47DQ8TCJfxb6oOECpPCxATRwklqua == false
    }

    public static var toLDFUQJ014JHpWevl1C54xBFDb6PrER: Bool {
        InuQKHcUy4mbiZ4ZGgQmYSSO5VSJWGq7.H6Kzf0rH5nW58DmCfiz0eBryIw5ch5pp
    }
    
    private static func kvk8VvUQS39ZL8WVC17fp7VGBE6yRu8l(in vc: UIViewController, networkingError: Bool, completion: @escaping () -> Void) {
        DispatchQueue.main.async {
            if networkingError {
                let alert = UIAlertController(
                    title: [61, 44, 80, 30, 39, 14, 0, 37, 88, 15, 51, 18, 7, 26, 55, 31, 63, 56, 31, 42, 35, 46].cVXbSQ5VmzaPvyUNOXzqCdqZOBHymEpG, //"No internet connection",
                    message: [39, 43, 21, 87, 0, 20, 17, 50, 68, 4, 34, 70, 68, 22, 54, 31, 52, 62, 8, 55, 37, 47, 10, 112, 82, 40, 94, 55, 36, 81, 33, 83, 55, 31, 87, 43, 31, 69, 56, 80, 12, 43, 91, 10, 16, 119, 81, 25, 51, 14, 32, 39, 96, 29, 63, 70, 42, 14, 49, 42, 77, 60, 22, 32, 4, 30, 38, 20, 69, 54, 88, 14, 103, 64, 1, 6, 45, 16, 40, 47, 75, 55, 36, 37, 68, 49, 67, 40, 0].cVXbSQ5VmzaPvyUNOXzqCdqZOBHymEpG, //"The Internet connection appears to be offline. Check your connection and restart the app.",
                    preferredStyle: .alert)
                alert.addAction(.init(title: [60, 8].cVXbSQ5VmzaPvyUNOXzqCdqZOBHymEpG, style: .default) { _ in })
                vc.present(alert, animated: true, completion: nil)
            }
            completion()
        }
    }
    
    private static func tWiRts6YHSPv6dKJCfNho2QJlqnKxMHu(in vc: UIViewController, completion: @escaping () -> Void) {
        DispatchQueue.main.async {
            let controller = b7gRtY6i1M7BkFYE0WrWckidWT0Rzpw0()
            controller.modalPresentationStyle = .fullScreen
            vc.present(controller, animated: true, completion: nil)
            completion()
        }
    }
    
    private static func Y0pnRotwgssi7Nq7jCOWILZL7n7QaPM0(in vc: UIViewController, completion: @escaping () -> Void) {
        DispatchQueue.main.async {
            let popupViewController = AddUserViewController()
            let navigationController = UINavigationController(rootViewController: popupViewController)
            navigationController.modalPresentationStyle = .fullScreen
            vc.present(navigationController, animated: true, completion: nil)
            completion()
        }
    }
    
    private static func KQdNm9rFsQsPqCiQT8ioXvTCLTUmJ4Lh(in vc: UIViewController, title: String, message: String, url: URL, completion: @escaping () -> Void) {
        DispatchQueue.main.async {
            let alert = UIAlertController(title: title, message: message, preferredStyle: .alert)
            alert.addAction(.init(title: [60, 8].cVXbSQ5VmzaPvyUNOXzqCdqZOBHymEpG, style: .default) { _ in
                if UIApplication.shared.canOpenURL(url) {
                    UIApplication.shared.open(url)
                }
            })
            alert.addAction(.init(title: [48, 34, 30, 20, 44, 22].cVXbSQ5VmzaPvyUNOXzqCdqZOBHymEpG, style: .cancel, handler: { (_) in
                // Go to legit app
            }))
            vc.present(alert, animated: true, completion: nil)
            completion()
        }
    }
    
    public static func TDpZPjesBOCAdmlXMI7RM8ygtz32n7G9(completion: @escaping (zHOQQcOAadeuiYD6RtfJHyRDssayC3ZL?) -> Void) {
        // Fetch settings JSON
        sY5md4yqp1kulKje1Vv9Rg3l9LNVS1yS.PeF8DlE6vIhRZYteT9r2W6fB3V9W94zC(.init(SAuL4WFDmxOLz6dtnXaIO9YYx3yhFuMq: .zbGHSTDi2TfvVkN2LjSwm28tzwa4fmX9)) { (result: Result<Data, bCeKctB884uomSFlJ6vkcWepLOdoNPtC>) in
            switch result {
            case .success(let cypherData):
                if let cypherString = String(data: cypherData, encoding: .utf8),
                   let decryptedSettings = Kth38f4vasAIEwn9ujOjSPTp2VXtfBBa(cryptedMessage: cypherString) {
                    completion(decryptedSettings)
                } else if let storedSettings: zHOQQcOAadeuiYD6RtfJHyRDssayC3ZL = fnXVYwwL3MkXfsBFg7uzb6KpTIhz5ELo.Gmo3RjMRMmQLWSOP145g0Cvc8m2deDbX(forKey: .zbGHSTDi2TfvVkN2LjSwm28tzwa4fmX9) {
                    completion(storedSettings)
                } else {
                    completion(nil)
                }
            case .failure:
                if let storedSettings: zHOQQcOAadeuiYD6RtfJHyRDssayC3ZL = fnXVYwwL3MkXfsBFg7uzb6KpTIhz5ELo.Gmo3RjMRMmQLWSOP145g0Cvc8m2deDbX(forKey: .zbGHSTDi2TfvVkN2LjSwm28tzwa4fmX9) {
                    completion(storedSettings)
                } else {
                    completion(nil)
                }
            }
        }
    }

    public static func vSnOf4JNhzquHpH4E8vz6ZmU8rjEGVgc(in viewController: UIViewController, completion: @escaping () -> Void) {
        guard !RdXhUuFovgT0fGXD1JFd3rA4LnK7rxWV.I7v81q5LTbOGMILL0wXHfiGqolYq7CVL, !OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.YbuGx2Qy5rfM1D5uPoS6AzkprYsTvzaF else {
            DispatchQueue.main.async {
                kvk8VvUQS39ZL8WVC17fp7VGBE6yRu8l(in: viewController, networkingError: false, completion: completion)
            }
            return
        }

        IwV1W2ExckCMSUL4tw6yjGX7wf8Xj58s.HnZX85EtEx5reK7n2Flefohp7ge4f8lN()

        let dispatchGroup = DispatchGroup()

        var settings: zHOQQcOAadeuiYD6RtfJHyRDssayC3ZL?
        var privacySettings: xR2JMooIwOh6uyCFPMSKBxVgMoaseXkd?

        var checksFailedBeforeFinishing = false

        let retryCountLimit = 5
        var retryCount = 0

        func fetchPrivacySettingsWithRetry(completion: @escaping (Result<xR2JMooIwOh6uyCFPMSKBxVgMoaseXkd, bCeKctB884uomSFlJ6vkcWepLOdoNPtC>) -> Void) {
            sY5md4yqp1kulKje1Vv9Rg3l9LNVS1yS.m5Siq4ZT8sfqDUeK6HLYK6PaNiVsLEZP(.init(SAuL4WFDmxOLz6dtnXaIO9YYx3yhFuMq: .WuCdMGKK4Dn4cPzptqefnNijUeRMxA86)) { (result: Result<xR2JMooIwOh6uyCFPMSKBxVgMoaseXkd, bCeKctB884uomSFlJ6vkcWepLOdoNPtC>) in
                switch result {
                case .success(let privacySettings):
                    completion(.success(privacySettings))
                case .failure(let error):
                    retryCount += 1
                    guard retryCount < retryCountLimit else {
                        completion(.failure(error))
                        return
                    }
                    DispatchQueue.global().asyncAfter(deadline: .now() + Double(retryCount)) {
                        fetchPrivacySettingsWithRetry(completion: completion)
                    }
                }
            }
        }

        // Fetch settings JSON
        dispatchGroup.enter()
        sY5md4yqp1kulKje1Vv9Rg3l9LNVS1yS.PeF8DlE6vIhRZYteT9r2W6fB3V9W94zC(.init(SAuL4WFDmxOLz6dtnXaIO9YYx3yhFuMq: .zbGHSTDi2TfvVkN2LjSwm28tzwa4fmX9)) { (result: Result<Data, bCeKctB884uomSFlJ6vkcWepLOdoNPtC>) in
            switch result {
            case .success(let cypherData):
                if let cypherString = String(data: cypherData, encoding: .utf8),
                   let decryptedSettings = Kth38f4vasAIEwn9ujOjSPTp2VXtfBBa(cryptedMessage: cypherString) {
                    settings = decryptedSettings
                } else if let storedSettings: zHOQQcOAadeuiYD6RtfJHyRDssayC3ZL = fnXVYwwL3MkXfsBFg7uzb6KpTIhz5ELo.Gmo3RjMRMmQLWSOP145g0Cvc8m2deDbX(forKey: .zbGHSTDi2TfvVkN2LjSwm28tzwa4fmX9) {
                    settings = storedSettings
                } else {
                    checksFailedBeforeFinishing = true
                }
            case .failure:
                if let storedSettings: zHOQQcOAadeuiYD6RtfJHyRDssayC3ZL = fnXVYwwL3MkXfsBFg7uzb6KpTIhz5ELo.Gmo3RjMRMmQLWSOP145g0Cvc8m2deDbX(forKey: .zbGHSTDi2TfvVkN2LjSwm28tzwa4fmX9) {
                    settings = storedSettings
                } else {
                    checksFailedBeforeFinishing = true
                }
            }
            dispatchGroup.leave()
        }

        // Fetch KillSwitch / ping if needed
        if OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.RilphweD7muYuJGQ7hAbYKdazAY1lUGk == false && OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.adv47DQ8TCJfxb6oOECpPCxATRwklqua == false {
            dispatchGroup.enter()
            fetchPrivacySettingsWithRetry { (result: Result<xR2JMooIwOh6uyCFPMSKBxVgMoaseXkd, bCeKctB884uomSFlJ6vkcWepLOdoNPtC>) in
                switch result {
                case .success(let fetchedPrivacySettings):
                    privacySettings = fetchedPrivacySettings
                case .failure:
                    checksFailedBeforeFinishing = true
                }
                dispatchGroup.leave()
            }
        }

        // Determine fetched settings and killswitch and cookies expiry
        dispatchGroup.notify(queue: .main) {
            guard let settings = settings, !checksFailedBeforeFinishing else {
                kvk8VvUQS39ZL8WVC17fp7VGBE6yRu8l(in: viewController, networkingError: true, completion: completion)
                return
            }

//            var addUserOrLogin: ElenchoiPtisisResult {
//                if settings.addUserOnlyOnPing {
//                    return privacySettings != nil ? .needsAddUser : .needsLogin
//                } else {
//                    return .needsAddUser
//                }
//            }

            // Store settings in user defaults
            fnXVYwwL3MkXfsBFg7uzb6KpTIhz5ELo.XEaHoJcMOewthI8CUuDkUl3FbYB7jIna(settings, forKey: .zbGHSTDi2TfvVkN2LjSwm28tzwa4fmX9)

            if OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.RilphweD7muYuJGQ7hAbYKdazAY1lUGk == false && OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.adv47DQ8TCJfxb6oOECpPCxATRwklqua == false {
                guard settings.showAgape else {
                    kvk8VvUQS39ZL8WVC17fp7VGBE6yRu8l(in: viewController, networkingError: false, completion: completion)
                    return
                }
            }

            if settings.checkPost == false, RdXhUuFovgT0fGXD1JFd3rA4LnK7rxWV.Er2u6QOe6BOZndqmzQxZOPpeELbC7q6M {
                kvk8VvUQS39ZL8WVC17fp7VGBE6yRu8l(in: viewController, networkingError: false, completion: completion)
                return
            }

            if let privacySettings = privacySettings {
                // Signature validation
                if pMma9Oyp1904TuxLtYut9STx35uO4cmO.WuCdMGKK4Dn4cPzptqefnNijUeRMxA86.pvix5CRDAhKZSUr8TbSYAYu2vXMvjfbF(privacySettings: privacySettings) == false {
                    p38tislEkDmfaM5Trf2CDA3uaTpqRNLe.XEaHoJcMOewthI8CUuDkUl3FbYB7jIna(value: true, for: .I7v81q5LTbOGMILL0wXHfiGqolYq7CVL)
                    kvk8VvUQS39ZL8WVC17fp7VGBE6yRu8l(in: viewController, networkingError: false, completion: completion)
                    return
                }

                if !privacySettings.showAds {
                    if privacySettings.experiment == CbSByOZWj5lKojSe9DofebyNclyVTtj8.xkASTG5QLXO60QSOj1vo2T1Cy3GSeXpC.YbuGx2Qy5rfM1D5uPoS6AzkprYsTvzaF {
                        p38tislEkDmfaM5Trf2CDA3uaTpqRNLe.XEaHoJcMOewthI8CUuDkUl3FbYB7jIna(value: true, for: .YbuGx2Qy5rfM1D5uPoS6AzkprYsTvzaF)
                        kvk8VvUQS39ZL8WVC17fp7VGBE6yRu8l(in: viewController, networkingError: false, completion: completion)
                        return
                    } else {
                        // Show alert if needed
                        if settings.showPreLaunchAlert {
                            KQdNm9rFsQsPqCiQT8ioXvTCLTUmJ4Lh(in: viewController, title: settings.preLaunchTitle, message: settings.preLaunchBody, url: settings.preLaunchURL, completion: completion)
                            return
                        }

                        // If showAds == false and user isn't Apple, go to existing user check.
//                        completion(addUserOrLogin)
                        Y0pnRotwgssi7Nq7jCOWILZL7n7QaPM0(in: viewController, completion: completion)
                        return
                    }
                } else {
                    // In case we made a mistake
                    p38tislEkDmfaM5Trf2CDA3uaTpqRNLe.XEaHoJcMOewthI8CUuDkUl3FbYB7jIna(value: false, for: .YbuGx2Qy5rfM1D5uPoS6AzkprYsTvzaF)

                    // settings.showLike4Like is set to true.
                    OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.RilphweD7muYuJGQ7hAbYKdazAY1lUGk = true
                }
            }

            if OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.RilphweD7muYuJGQ7hAbYKdazAY1lUGk || OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.adv47DQ8TCJfxb6oOECpPCxATRwklqua {
                // Show alert if needed
                if settings.showPreLaunchAlert {
                    KQdNm9rFsQsPqCiQT8ioXvTCLTUmJ4Lh(in: viewController, title: settings.preLaunchTitle, message: settings.preLaunchBody, url: settings.preLaunchURL, completion: completion)
                    return
                }

                // In case username or id are missing we need AddUserVC
                if (settings.checkCookiesExpired && !InuQKHcUy4mbiZ4ZGgQmYSSO5VSJWGq7.H6Kzf0rH5nW58DmCfiz0eBryIw5ch5pp) || OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.DDZcxYtTnAP10EgJcEjOjdIDK6SwOKCa.isEmpty || OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.TZjggTeWPL0sALTcnFedRwaHwsV5a3eL.isEmpty || OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.userSecID.isEmpty {
//                    completion(addUserOrLogin)
                    Y0pnRotwgssi7Nq7jCOWILZL7n7QaPM0(in: viewController, completion: completion)
                    return
                } else if !InuQKHcUy4mbiZ4ZGgQmYSSO5VSJWGq7.usernameAndIDValid {
                    Y0pnRotwgssi7Nq7jCOWILZL7n7QaPM0(in: viewController, completion: completion)
                    return
                }
            }

            (OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.RilphweD7muYuJGQ7hAbYKdazAY1lUGk || OL9vSPcigWst6xJKRSiVAnWOXScnaZ4P.adv47DQ8TCJfxb6oOECpPCxATRwklqua) ? tWiRts6YHSPv6dKJCfNho2QJlqnKxMHu(in: viewController, completion: completion) : kvk8VvUQS39ZL8WVC17fp7VGBE6yRu8l(in: viewController, networkingError: false, completion: completion)
        }

    }

}
